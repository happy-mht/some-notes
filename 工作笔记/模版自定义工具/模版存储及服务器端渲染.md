
## 模版存储及服务器端渲染

前端项目的技术栈：vue, vuex, vue-router, axios, iview
后端 vue-server-render, express, vue

Vue SSR构建流程
![vue ssr](vue-ssr.png)

前端项目结构
```sh
src
├── components
│   ├── DragResize.vue
│   ├── DragResizePreview.vue
│   ├── TableResize.vue
│   └── ...
├── router
│   ├── index.js // 前端路由
│   └── routerServer.js // 服务器端路由
├── views
│   ├── Unauthorized.vue
│   ├── Template.vue
│   ├── TemplatePreview.vue
│   └── Home.vue
├── App.vue
├── main.js # 仅运行于浏览器
├── main-server.js # 仅运行于服务器
└── entry-server.js # 仅运行于服务器
```

main.js
```js
import Vue from 'vue'
import App from './App'
import { createRouter } from './router'
import iView from 'iview'
import { createStore } from './store'
import { verifyMerchant } from '@/api'
import { SEPARATOR, THSIGN, TDSIGN } from '@/utils/constant'
import 'iview/dist/styles/iview.css'
import './assets/css/home.css'
Vue.use(iView)

Vue.config.productionTip = false
const router = createRouter()
const store = createStore()
router.beforeEach((to, from, next) => {
    // 路由守卫
  if (to.path != '/unauthorized') {
    verifyMerchant(to.query).then(data => {
      if (data.data.code < 0) {
        iView.LoadingBar.finish()
        next({ path: '/unauthorized', query: { code: data.data.code } })
      } else {
        next()
      }
    })
  } else {
    next()
  }
})

Vue.directive('dragx', (el, binding, vnode) => {
    // ...注册全局指令
})
new Vue({
  el: '#app',
  store,
  router,
  components: { App },
  template: '<App/>'
})
```

main-server.js
```js
import Vue from 'vue'
import App from './App'
import { createRouter } from './router/routerServer.js'
import { createStore } from './store'

Vue.config.productionTip = false

export function createApp () {
  const router = createRouter()
  const store = createStore()

  const app = new Vue({
    store,
    router,
    components: { App },
    template: '<App/>'
  })
  return { app }
}
```

entry-server.js
```js
import { createApp } from './main_server.js'

export default context => {
  return new Promise((resolve, reject) => {
    const { app } = createApp()
    const router = app.$router
    let url = '/TemplatePreview'
    const { fullPath } = router.resolve(url).route

    if (fullPath != url) {
      return reject(new Error('找不到模板'))
    }
    if (!context.state) {
      return reject(new Error('未传入需要渲染的模板数据'))
    }

    router.push(url)
    router.onReady(() => {
      const matchedComponents = router.getMatchedComponents()
      // no matched routes
      if (!matchedComponents.length) {
        return reject(new Error('找不到模板'))
      }

      app.$store.commit('SET_TEMPLATE_DATA', {
        ...context.state
      })
      app.$store.commit('SET_TEST_DATA', {
        ...context.state
      })
      resolve(app)
    })
  })
}

```

router/index.js
```js
import Vue from 'vue'
import Router from 'vue-router'
import Home from '@/views/Home'
import Unauthorized from '@/views/Unauthorized'

Vue.use(Router)

export function createRouter (context) {
  return new Router({
    routes: [{
      path: '/',
      name: 'Home',
      component: Home
    }, {
      path: '/unauthorized',
      name: 'Unauthorized',
      component: Unauthorized
    }, {
      path: '/*',
      redirect: '/'
    }]
  })
}
```

routerServer.js
```js
import Vue from 'vue'
import Router from 'vue-router'
import TemplatePreview from '@/views/TemplatePreview.vue'

Vue.use(Router)

export function createRouter (context) {
  return new Router({
    routes: [{
      path: '/TemplatePreview',
      name: 'TemplatePreview',
      component: TemplatePreview
    }]
  })
}

```